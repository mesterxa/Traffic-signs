<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizzes - DriveLearn</title>
<link rel="stylesheet" href="style.css">

<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background: #f7f8fa;
  color: #2c2c2c;
  transition: background 0.5s, color 0.5s;
}
body.dark { background: #1a1a1a; color: #eee; }
.rtl { direction: rtl; text-align: right; }

.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #1565c0;
  padding: 12px 20px;
  color: #fff;
}
body.dark .navbar { background: #0d47a1; }
.navbar a { color: #fff; text-decoration: none; margin-left: 15px; font-weight: 500; }
.navbar a:hover { text-decoration: underline; }
.logo-img { height: 40px; }

.container {
  display: flex;
  justify-content: space-between;
  max-width: 1000px;
  margin: 40px auto;
}

.quiz-box, .leaderboard-box {
  background: #fff;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  transition: background 0.5s, color 0.5s, transform 0.3s, opacity 0.5s;
}
body.dark .quiz-box, body.dark .leaderboard-box { background: #2c2c2c; color: #eee; }

.quiz-box { flex: 2; margin-right: 20px; position: relative; }
.leaderboard-box { flex: 1; max-width: 250px; }

h2 { text-align: center; }

button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  border: none;
  background: #1565c0;
  color: #fff;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}
button:hover { background: #0d47a1; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
button.correct { background: #34c759 !important; }
button.wrong { background: #ff3b30 !important; }
button:active { transform: scale(0.95); }

.ios-toast {
  position: fixed;
  top: -120px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.96);
  color: #000;
  padding: 14px 22px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 500;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  transition: all 0.45s cubic-bezier(.25,.8,.25,1);
  z-index: 9999;
}
.ios-toast.show { top: 25px; }
.ios-toast.success { border-left: 5px solid #34c759; }
.ios-toast.error { border-left: 5px solid #ff3b30; }

ul { list-style: none; padding: 0; }
li { margin-bottom: 8px; }
img.sign { width: 120px; display: block; margin: 0 auto 15px auto; }
.timer { font-weight: bold; margin-bottom: 10px; text-align: center; font-size: 18px; }

.fade-out { opacity: 0; transform: translateY(-20px); }
.fade-in { opacity: 1; transform: translateY(0); transition: all 0.5s; }

.point-animation {
  position: absolute;
  font-size: 20px;
  font-weight: bold;
  color: #34c759;
  animation: pointUp 1s forwards;
}
@keyframes pointUp {
  0% { opacity: 1; transform: translateY(0);}
  100% { opacity: 0; transform: translateY(-40px);}
}

.level-up {
  position: absolute;
  top: 30%;
  left: 50%;
  transform: translateX(-50%);
  background: #ffd700;
  color: #000;
  padding: 15px 25px;
  font-size: 24px;
  font-weight: bold;
  border-radius: 12px;
  animation: fadeLevel 1.2s forwards;
  z-index: 1000;
}
@keyframes fadeLevel {
  0% { opacity: 0; transform: translate(-50%, -20px);}
  50% { opacity: 1; transform: translate(-50%, 0);}
  100% { opacity: 0; transform: translate(-50%, -20px);}
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAukmQBNFxX_AhpxYOQfDVtGux07OkzN6Q",
  authDomain: "traffic-signs-fc047.firebaseapp.com",
  projectId: "traffic-signs-fc047",
  storageBucket: "traffic-signs-fc047.appspot.com",
  messagingSenderId: "746457575630",
  appId: "1:746457575630:web:3219b85b64e2307126609f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userEmail = "";
let userFullname = "";
let userScore = 0;
let currentLevel = 1;
let timerInterval;

const correctSound = new Audio('sounds/correct.mp3');
const wrongSound = new Audio('sounds/wrong.mp3');

const quizData = [
  { sign: "images/red_light.png", options: ["Stop", "Go", "Yield"], correct: 0 },
  { sign: "images/stop_sign.png", options: ["Go", "Stop", "Caution"], correct: 1 },
  { sign: "images/yield.png", options: ["Stop", "Yield", "Go"], correct: 1 },
  { sign: "images/pedestrian.png", options: ["No Pedestrians", "School Zone", "Pedestrian Crossing"], correct: 2 },
  { sign: "images/traffic_info.png", options: ["Stop", "Info", "Yield"], correct: 1 }
];

onAuthStateChanged(auth, async user => {
  if(!user) { window.location.href = "login.html"; return; }
  userEmail = user.email;
  const userDoc = await getDoc(doc(db, "users", userEmail));
  if(userDoc.exists()) userFullname = userDoc.data().fullname || "Student";
  loadQuestion();
  updateLeaderboard();
});

function loadQuestion() {
  clearInterval(timerInterval);
  const quizBox = document.getElementById("quiz-box");
  const question = quizData[Math.floor(Math.random()*quizData.length)];
  let timeLeft = 15;

  quizBox.classList.add("fade-out");
  setTimeout(() => {
    quizBox.innerHTML = `
      <h2>Level ${currentLevel}</h2>
      <div class="timer" id="timer">Time: ${timeLeft}s</div>
      <img src="${question.sign}" class="sign">
      ${question.options.map((opt, idx)=> `<button onclick="checkAnswer(this, ${idx}, ${question.correct})">${opt}</button>`).join('')}
      <p>Score: <strong id="score">${userScore}</strong></p>
    `;
    quizBox.classList.remove("fade-out");
    quizBox.classList.add("fade-in");
  },300);

  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").innerText = `Time: ${timeLeft}s`;
    if(timeLeft<=0){ clearInterval(timerInterval); showToast("Time's up ❌","error"); nextQuestion(); }
  },1000);
}

async function checkAnswer(button, selected, correct){
  clearInterval(timerInterval);
  const points = 10 * currentLevel;
  const quizBox = document.getElementById("quiz-box");

  if(selected === correct){
    userScore += points;
    button.classList.add("correct");
    correctSound.play();
    showToast("Correct ✅","success");

    const pointAnim = document.createElement("div");
    pointAnim.className="point-animation";
    pointAnim.innerText = `+${points}`;
    button.appendChild(pointAnim);
    setTimeout(()=>pointAnim.remove(),1000);
  } else {
    button.classList.add("wrong");
    wrongSound.play();
    showToast("Wrong ❌","error");
  }

  await setDoc(doc(db,"results",userEmail), { result:userScore, fullname:userFullname });
  setTimeout(nextQuestion,1200);
}

function nextQuestion(){
  currentLevel++;
  showLevelUp(currentLevel);
  loadQuestion();
  updateLeaderboard();
  document.body.style.background = `hsl(${(currentLevel*50)%360}, 60%, 90%)`;
}

function showLevelUp(level){
  const quizBox = document.getElementById("quiz-box");
  const lvlDiv = document.createElement("div");
  lvlDiv.className="level-up";
  lvlDiv.innerText = `Level ${level}`;
  quizBox.appendChild(lvlDiv);
  setTimeout(()=>lvlDiv.remove(),1200);
}

async function updateLeaderboard(){
  const lbContainer = document.getElementById("leaderboard");
  const snapshot = await getDocs(collection(db,"results"));
  const leaderboard=[];
  snapshot.forEach(doc=>{ const data=doc.data(); leaderboard.push({name:data.fullname||doc.id, score:data.result||0}); });
  leaderboard.sort((a,b)=>b.score-a.score);

  lbContainer.innerHTML="<h3>Leaderboard</h3><ul>"+
    leaderboard.slice(0,5).map(u=>`<li>${u.name} - ${u.score}</li>`).join('')+"</ul>";
}

function showToast(message,type="success"){
  const toast=document.getElementById("ios-toast");
  toast.textContent=message;
  toast.className=`ios-toast show ${type}`;
  setTimeout(()=>toast.classList.remove("show"),2000);
}

if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
  document.body.classList.add('dark');
}
</script>
</head>

<body>
<div class="navbar">
  <img src="logo.png" class="logo-img" alt="DriveLearn">
  <div>
    <a href="index.html">Home</a>
    <a href="quizzes.html">Quizzes</a>
    <a href="result.html">Results</a>
  </div>
</div>

<div class="container">
  <div class="quiz-box" id="quiz-box">Loading quiz...</div>
  <div class="leaderboard-box" id="leaderboard">Loading leaderboard...</div>
</div>

<div id="ios-toast" class="ios-toast"></div>
</body>
</html>